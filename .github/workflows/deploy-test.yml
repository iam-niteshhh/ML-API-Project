name: Deploy to Render - Test

on:
  push:
    branches:
      - test

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: echo "Code checked out from branch ${{ github.ref }}"

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: 3.12
      - run: |
          echo "Python version set to:"
          python --version

      - name: Trigger Deploy to Render (Test)
        run: |
          echo "Starting deploy to Render for branch: ${{ github.ref }}"
          echo "Sending POST request to Render Deploy Hook..."

          # Perform the request and capture both response body and HTTP status
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_TEST }}")
          body=$(echo "$response" | head -n -1)
          status=$(echo "$response" | tail -n 1)

          echo "Response Body:"
          echo "$body"
          echo ""
          echo "HTTP Status Code: $status"

          # Always print even if it's suspended
          if [ "$status" -ne 200 ]; then
            echo " Deployment returned non-200 status"
            echo "Reason: $body"
            exit 1
          else
            echo "Deployment successfully triggered!"
          fi
